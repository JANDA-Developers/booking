import React from "react";
import {useDayPicker} from "../../actions/hook";
import moment from "moment";
import {
  getAllRoomTypeWithGuest,
  getAllRoomTypeWithGuestVariables
} from "../../types/api";
import {Query} from "react-apollo";
import {GET_ALL_ROOMTYPES_WITH_GUESTS_WITH_ITEM} from "../../apollo/queries";
import {queryDataFormater} from "../../utils/utils";
import {PricingType} from "../../types/enum";
import {IHouse} from "../../types/interface";

class GetAllRoomTypeWithGuestQuery extends Query<
  getAllRoomTypeWithGuest,
  getAllRoomTypeWithGuestVariables
> {}

interface IProps {
  house: IHouse;
}

const HMwrap: React.FC<IProps> = ({house}) => {
  const queryDateHook = useDayPicker(
    moment(new Date())
      .add(-1, "day")
      .toDate(),
    new Date()
  );

  return (
    <GetAllRoomTypeWithGuestQuery
      query={GET_ALL_ROOMTYPES_WITH_GUESTS_WITH_ITEM}
      variables={{
        start: queryDateHook.from,
        end: queryDateHook.to,
        houseId: house.houseId
      }}
    >
      {({data, loading, error}) => {
        const roomTypesData = queryDataFormater(
          data,
          "GetAllRoomType",
          "roomTypes",
          undefined
        ); // 원본데이터

        const guestsData = queryDataFormater(
          data,
          "GetGuests",
          "guests",
          undefined
        ); // 원본데이터

        const blocks = queryDataFormater(
          data,
          "GetBlocks",
          "blocks",
          undefined
        );

        const getPricingTypesMaxCount = () => {
          let domitoryCount = 0;
          let roomCount = 0;
          if (roomTypesData) {
            roomTypesData.forEach(roomType => {
              if (roomType.pricingType === PricingType.DOMITORY) {
                domitoryCount += roomType.peopleCount;
              } else if (roomType.pricingType === PricingType.ROOM) {
                domitoryCount += roomType.roomCount;
              }
            });
          }
          return {domitoryCount, roomCount};
        };

        const {domitoryCount, roomCount} = getPricingTypesMaxCount();

        return (
          <DayVacancy domitoryCount={domitoryCount} roomCount={roomCount} />
        );
      }}
    </GetAllRoomTypeWithGuestQuery>
  );
};

export default HMwrap;
